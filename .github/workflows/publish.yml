name: Publish Cambria Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-release:
    name: Build, Test & Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      FOSSIL_REMOTE: https://ipsaw.com/cambria
      BUILD_ROOT: canonical/source
    steps:
      - name: Install fossil and build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y fossil make

      - name: Clone fossil canonical repository
        run: |
          mkdir -p canonical
          cd canonical
          fossil clone "$FOSSIL_REMOTE" cambria.fossil
          mkdir -p source
          cd source
          fossil open ../cambria.fossil

      - name: Build
        run: |
          cd "$BUILD_ROOT"
          make build

      # - name: Test
      #   run: |
      #     cd "$BUILD_ROOT"
      #     make test

      - name: Capture version and stage binary
        id: version
        run: |
          cd "$BUILD_ROOT"
          VERSION_OUTPUT=$(./cambria --version | tr -d '\r')
          if [ -z "$VERSION_OUTPUT" ]; then
            echo "cambria version returned no data" >&2
            exit 1
          fi
          VERSION_TAG=$(echo "$VERSION_OUTPUT" | awk '{print $NF}')
          if [ -z "$VERSION_TAG" ]; then
            echo "Unable to determine release tag from version output: $VERSION_OUTPUT" >&2
            exit 1
          fi
          echo "version_string=$VERSION_OUTPUT" >> "$GITHUB_OUTPUT"
          echo "version_tag=$VERSION_TAG" >> "$GITHUB_OUTPUT"
          mkdir -p release-artifacts
          cp cambria ../../release-artifacts/cambria
          chmod +x ../../release-artifacts/cambria

      - name: Ensure tag is new
        env:
          TAG_NAME: ${{ steps.version.outputs.version_tag }}
        run: |
          if git ls-remote --exit-code --tags origin "refs/tags/${TAG_NAME}" >/dev/null 2>&1; then
            echo "Tag ${TAG_NAME} already exists on origin. Aborting release." >&2
            exit 1
          fi

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: cambria-${{ steps.version.outputs.version_tag }}
          path: release-artifacts/cambria

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version_tag }}
          name: Cambria ${{ steps.version.outputs.version_string }}
          body: |
            Automated release built from ${{ env.FOSSIL_REMOTE }}.
            Generated by workflow_dispatch with no manual tagging.
          files: release-artifacts/cambria
          draft: false
          prerelease: false
